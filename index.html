<html>
  <head>
    <meta charset="utf-8">
    <title>Conduit</title>
    <link href="//code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Titillium+Web:700|Source+Serif+Pro:400,700|Merriweather+Sans:400,700|Source+Sans+Pro:400,300,600,700,300italic,400italic,600italic,700italic" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="//demo.productionready.io/main.css">
  </head>
  <body></body>
  <script src="utils.js"></script>
  <script src="api.js"></script>
  <script src="pages/body.js"></script>
  <script src="pages/home.js"></script>
  <script src="pages/article.js"></script>
  <script src="pages/profile.js"></script>
  <script src="pages/register-login.js"></script>
  <script src="pages/settings.js"></script>
  <script src="pages/editor.js"></script>
  <script>
    const 
    
    $ = selector => document.querySelector(selector),

    $all = selector => document.querySelectorAll(selector),

    $form_to_json = selector => Array.from($all(`${selector} [name]`)).reduce((json, i) => add(json, i.name, i.value), {}),

    on_hash_changed = fn => window.addEventListener('hashchange', fn, false),
    
    on = (event, selector, fn) => document.addEventListener(event, e => e.target.matches(selector) && fn(e), true),

    prevent = fn => e => { e.preventDefault(); fn(e) },
    
    render_page = page => json => document.body.innerHTML = page_body(saved_user(), page(json), page.name),

    render_page_with_context = (page, context) => json => render_page(page)(merge([json, context])),
    
    hash = () => window.location.hash,

    first_route_matched_hash = routes => routes.filter(([regex]) => regex.test(hash()))[0],

    use_route = ([regex, fn]) => fn(regex.exec(hash())[1]),

    create_dispatch_hash = routes => () => use_route(first_route_matched_hash(routes)),

    r = str => new RegExp(`^${str}/?$`),
    
    fetch_and_do = (fetch_res, fn) => fetch_res.then(fn),
  
    fetch_and_render = (fetch_fn, page_fn) => (...args) => fetch_and_do(fetch_fn(...args), render_page(page_fn)),
    
    render_home = fetch_and_render(get_home_page, page_home),

    redirect_to_hash = hash_str => location.hash = hash_str,

    redirect_to_home = () => redirect_to_hash('/'),

    redirect_to_article = ({ article: { slug } }) => redirect_to_hash('/article/' + slug),

    redirect_to_register = () => redirect_to_hash('/register'),

    redirect_to_user = () => redirect_to_hash('/' + saved_user().user.username),
    
    refresh_page = () => dispatch_hash(hash()),

    authenticate_user = user => { save_user(user); redirect_to_home() },

    logout = () => { remove_user(); redirect_to_home() },

    user_is_anon = fn => ([() => !saved_user(), fn]),

    user_is_auth = fn => ([() => saved_user(), fn]),

    user_is_author = fn => ([username => saved_user() && saved_user().user.username, fn])

    dispatch_hash = create_dispatch_hash([
      [r('#/login'),             case_of(
                                  user_is_anon(render_page(page_login)), 
                                  user_is_auth(redirect_to_user))],

      [r('#/register'),          render_page(page_register)],
      [r('#/settings'),          fetch_and_render(get_user, page_settings)],
      [r('#/editor'),            render_page(page_editor)],
      [r('#/editor/([^/]+)'),    fetch_and_render(get_article, page_editor)],
      [r('#/article/([^/]+)'),   fetch_and_render(get_article_page, page_article)],
      [r('#/([^/]+)/favorites'), fetch_and_render(get_profile_favorites, page_profile_favorites)],
      [r('#/([^/]+)'),           fetch_and_render(get_profile_page, page_profile)],
      [r('$|.+'),                render_home],
    ]),

    resp_is_success = fn => ([json => !json.errors, fn]),

    resp_is_error = fn => ([json => !!json.errors, fn])

    on('click', '.tag-pill', prevent(({ target }) => render_home(['tag', target.innerText])))
    
    on('click', '.page-link', prevent(({ target }) => render_home(['offset', target.dataset.offset])))

    on('click', '#register-button', () => fetch_and_do(
      register_user($form_to_json('form')),
      case_of(
        resp_is_success(authenticate_user),
        resp_is_error(render_page_with_context(page_register, { user: $form_to_json('form') })))))

    on('click', '#login-button', () => fetch_and_do(
      login_user($form_to_json('form')), 
      case_of(
        resp_is_success(authenticate_user),
        resp_is_error(render_page_with_context(page_login, { user: $form_to_json('form') })))))

    on('click', '#publish-article', () => fetch_and_do(
      create_article($form_to_json('form')),
      case_of(
        resp_is_success(redirect_to_article),
        resp_is_error(render_page_with_context(page_editor, { article: $form_to_json('form') })))))
    
    on('click', '#logout-button', logout)

    on('click', '#favorite-button', ({ target }) => fetch_and_do(
      favorite_article(target.dataset.slug),
      case_of(
        resp_is_success(refresh_page),
        resp_is_error(redirect_to_register))))

    on('click', '#unfavorite-button', ({ target }) => fetch_and_do(
      unfavorite_article(target.dataset.slug),
      case_of(
        resp_is_success(refresh_page),
        resp_is_error(redirect_to_register))))

    on_hash_changed(dispatch_hash)

    dispatch_hash()
  </script>
</html>