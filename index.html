<html>
  <head>
    <meta charset="utf-8">
    <title>Conduit</title>
    <link href="//code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Titillium+Web:700|Source+Serif+Pro:400,700|Merriweather+Sans:400,700|Source+Sans+Pro:400,300,600,700,300italic,400italic,600italic,700italic" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="//demo.productionready.io/main.css">
  </head>
  <body></body>
  <script src="/utils.js"></script>
  <script src="/api.js"></script>
  <script src="/pages/body.js"></script>
  <script src="/pages/home.js"></script>
  <script src="/pages/article.js"></script>
  <script src="/pages/profile.js"></script>
  <script src="/pages/register-login.js"></script>
  <script src="/pages/settings.js"></script>
  <script src="/pages/editor.js"></script>
  <script>
    const 
    
    $ = selector => document.querySelector(selector),

    $all = selector => document.querySelectorAll(selector),

    $form_to_json = selector => Array.from($all(`${selector} [name]`)).reduce((json, i) => add(json, i.name, i.value), {}),

    on_hash_changed = fn => window.addEventListener('hashchange', fn, false),
    
    on = (event, selector, fn) => document.addEventListener(event, e => e.target.matches(selector) && fn(e), true),

    prevent = fn => e => { e.preventDefault(); fn(e) },
    
    render_page = page => json => document.body.innerHTML = page_body(saved_user(), page(json), page.name),

    render_page_with_context = (page, context) => json => render_page(page)(merge([json, context])),
    
    hash = () => window.location.hash,

    first_route_matched_hash = routes => routes.filter(([regex]) => regex.test(hash()))[0],

    use_route = ([regex, fn]) => fn(regex.exec(hash())[1]),

    create_dispatch_hash = routes => () => use_route(first_route_matched_hash(routes)),

    r = str => new RegExp(str),
    
    after_fetch_do = (fetch_res, ...fns) => fetch_res.then(json => fns.forEach(fn => fn(json))),
  
    fetch_and_render = (fetch_fn, page_fn) => (...args) => after_fetch_do(fetch_fn(...args), render_page(page_fn)),
    
    render_home = fetch_and_render(get_home_page, page_home),

    go_to_hash = hash_str => window.location.hash = hash_str,

    go_to_home = () => go_to_hash('/'),

    go_to_article = ({ article: { slug } }) => go_to_hash('/article/' + slug),

    authenticate_user = user => { save_user(user); go_to_home() },

    logout = () => { remove_user(); go_to_home() },

    dispatch_hash = create_dispatch_hash([
      [r('^#/login/?'),             render_page(page_login)],
      [r('^#/register/?'),          render_page(page_register)],
      [r('^#/settings/?'),          fetch_and_render(get_user, page_settings)],
      [r('^#/editor/?'),            render_page(page_editor)],
      [r('^#/article/([^/]+)/?'),   fetch_and_render(get_article_page, page_article)],
      [r('^#/([^/]+)/favorites/?'), fetch_and_render(get_profile_favorites, page_profile_favorites)],
      [r('^#/([^/]+)/?'),           fetch_and_render(get_profile_page, page_profile)],
      [r('^$|.+/?'),                render_home],
    ]),

    on_success = fn => json => !json.errors && fn(json),

    on_error = fn => json => json.errors && fn(json)

    on('click', '.tag-pill', prevent(({ target }) => render_home(['tag', target.innerText])))
    
    on('click', '.page-link', prevent(({ target }) => render_home(['offset', target.dataset.offset])))

    on('click', '#register-button', () => after_fetch_do(
      register_user($form_to_json('form')),
      on_success(authenticate_user), 
      on_error(render_page_with_context(page_register, { user: $form_to_json('form') }))
    ))

    on('click', '#login-button', () => after_fetch_do(
      login_user($form_to_json('form')), 
      on_success(authenticate_user),
      on_error(render_page_with_context(page_login, { user: $form_to_json('form') }))
    ))

    on('click', '#publish-article', () => after_fetch_do(
      create_article($form_to_json('form')),
      on_success(go_to_article),
      on_error(render_page_with_context(page_editor, { article: $form_to_json('form') }))
    ))
    
    on('click', '#logout-button', logout)

    on_hash_changed(dispatch_hash)

    dispatch_hash()
  </script>
</html>